<ion-header collapse="condense">
  <ion-toolbar class="search-toolbar">
    <div class="search-wrapper">
      <ion-searchbar
        [(ngModel)]="query"
        placeholder="Buscar productos, semillas, foliares..."
        debounce="300"
        (ionInput)="onSearchChange($event)"
        (ionFocus)="showSuggestions = true"
        (ionBlur)="hideSuggestionsDelayed()"
      ></ion-searchbar>

      <!-- SUGERENCIAS flotantes -->
      <div class="search-dropdown" *ngIf="showSuggestions">
        <div class="dropdown-section" *ngIf="suggestions.length > 0">
          <h4><ion-icon name="flame-outline"></ion-icon> Resultados sugeridos</h4>
          <div
            class="suggestion-item"
            *ngFor="let s of suggestions"
            (mousedown)="openSuggestion(s)"
          >
            <img [src]="s.imageUrl || 'assets/img/placeholder.png'" alt="" />
            <div class="info">
              <p class="title">{{ s.title }}</p>
              <p class="price">{{ money(s.price) }}</p>
            </div>
          </div>
        </div>

        <div class="dropdown-section popular" *ngIf="popularSearches.length > 0">
          <h4><ion-icon name="sparkles-outline"></ion-icon> Popular ahora</h4>
          <div class="chip-container">
            <button
              class="chip"
              *ngFor="let tag of popularSearches"
              (mousedown)="quickSearch(tag)"
            >
              <ion-icon name="time-outline"></ion-icon> {{ tag }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="mw-search">
  <div class="container">
    <div class="summary">
      <h2>
        Resultados para “{{ q || '...' }}”
        <small *ngIf="cat">en {{ cat }}</small>
      </h2>
      <button *ngIf="q || cat" class="clear" (click)="clear()">Limpiar</button>
    </div>

    <!-- Skeleton loading -->
    <div *ngIf="loading" class="grid">
      <ion-card class="skeleton" *ngFor="let i of [1,2,3,4,5,6,7,8]">
        <ion-skeleton-text animated style="width:100%; height:140px;"></ion-skeleton-text>
        <ion-card-content>
          <ion-skeleton-text animated style="width: 80%; height: 16px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 40%; height: 14px; margin-top:8px;"></ion-skeleton-text>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Sin resultados -->
    <div *ngIf="!loading && total===0" class="empty">
      <ion-icon name="search-outline"></ion-icon>
      <h3>Sin coincidencias</h3>
      <p>Prueba con términos generales: “semilla”, “maíz”, “foliar”…</p>
    </div>

    <!-- Resultados -->
    <div *ngIf="!loading && total>0" class="grid">
      <ion-card class="item" *ngFor="let p of results" (click)="open(p)">
        <div
          class="thumb"
          [style.backgroundImage]="'url(' + (p.imageUrl || 'assets/img/placeholder.png') + ')'"
        >
          <div class="badge pct" *ngIf="hasDiscount(p)">-{{ pct(p) }}%</div>
        </div>

        <ion-card-content>
          <div class="chips">
            <span class="chip">{{ p.category || 'General' }}</span>
          </div>
          <h4 [innerHTML]="p.title"></h4>

          <div class="price">
            <span class="now" *ngIf="p.price != null">
              {{ p.price | currency:'USD':'symbol':'1.2-2' }}
            </span>
            <span class="compare" *ngIf="hasDiscount(p)">
              {{ p.compareAt | currency:'USD':'symbol':'1.2-2' }}
            </span>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
  </div>
</ion-content>
